<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 产品信息记录（库存）(material) -->
<mapper namespace="com.dreamchaser.depository_manage.mapper.MaterialMapper">
    <!-- This code was generated by TableGo tools, mark 1 begin. -->
    <!-- 字段映射 -->
    <resultMap id="materialMap" type="com.dreamchaser.depository_manage.entity.Material">
        <id column="id" property="id" jdbcType="INTEGER" />
        <result column="depository_id" property="depositoryId" jdbcType="INTEGER" />
        <result column="mname" property="mname" jdbcType="VARCHAR" />
        <result column="quantity" property="quantity" jdbcType="VARCHAR" />
        <result column="price" property="price" jdbcType="VARCHAR" />
        <result column="type_id" property="typeId" jdbcType="INTEGER" />
    </resultMap>

    <!-- 表查询字段 -->
    <sql id="allColumns">
        m.id, m.depository_id, m.mname, m.quantity, m.price, m.type_id
    </sql>

    <!-- 查询所有数据的条数 -->
    <select id="findCount" resultType="integer">
        SELECT
        count(*)
        FROM material m
    </select>

    <!-- 查询所有符合条件的数据条数 -->
    <select id="findCountByCondition" parameterType="map" resultType="integer">
        SELECT
        count(*)
        FROM material m WHERE 1 = 1
        <if test="depositoryId != null">
            AND m.depository_id = #{depositoryId}
        </if>
        <if test="mname != null and mname != ''">
            AND m.mname LIKE CONCAT('%', #{mname}, '%')
        </if>
        <if test="quantity != null">
            AND m.quantity = #{quantity}
        </if>
        <if test="price != null">
            AND m.price = #{price}
        </if>
        <if test="typeId != null">
            AND m.type_id = #{typeId}
        </if>
    </select>

    <!-- 查询所有数据 -->
    <select id="findMaterialAll" resultMap="materialMap">
        SELECT
        count(*)
        FROM material m
    </select>
    
    <!-- 根据条件参数查询数据列表 -->
    <select id="findMaterialByCondition" resultMap="materialMap" parameterType="map">
        SELECT
        <include refid="allColumns" />
        FROM material m WHERE 1 = 1
        <if test="depositoryId != null">
            AND m.depository_id = #{depositoryId}
        </if>
        <if test="mname != null and mname != ''">
            AND m.mname LIKE CONCAT('%', #{mname}, '%')
        </if>
        <if test="quantity != null">
            AND m.quantity = #{quantity}
        </if>
        <if test="price != null">
            AND m.price = #{price}
        </if>
        <if test="typeId != null">
            AND m.type_id = #{typeId}
        </if>
        <if test="begin != null and size != null">
            LIMIT #{begin},#{size}
        </if>
    </select>

    <!-- 根据主键查询数据 -->
    <select id="findMaterialById" resultMap="materialMap" parameterType="integer">
        SELECT
        <include refid="allColumns" />
        FROM material m WHERE m.id =#{id}
    </select>

    <!-- 根据主键查询数据 -->
    <select id="findMaterialByIds" resultMap="materialMap" parameterType="list">
        SELECT
        <include refid="allColumns" />
        FROM material m WHERE m.id IN
        <foreach collection="ids" index="index" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>
    
    <!-- 插入数据 -->
    <insert id="insertMaterial" parameterType="map">
        INSERT INTO material (
            id, depository_id, mname, quantity, price, type_id
        ) VALUES (
            #{id},
            #{depositoryId},
            #{mname},
            #{quantity},
            #{price},
            #{typeId}
        )
    </insert>
    
    <!-- 批量插入数据 -->
    <insert id="insertMaterials" parameterType="list">
        INSERT INTO material (
            id, depository_id, mname, quantity, price, type_id
        ) VALUES
        <foreach collection="list" index="index" item="item" separator=",">
            (
                #{item.id},
                #{item.depositoryId},
                #{item.mname},
                #{item.quantity},
                #{item.price},
                #{item.typeId}
            )
        </foreach>
    </insert>
    
    <!-- 修改数据 -->
    <update id="updateMaterial">
        UPDATE material
        <set>
            <if test="depositoryId != null">
                depository_id = #{depositoryId},
            </if>
            <if test="mname != null">
                mname = #{mname},
            </if>
            <if test="quantity != null">
                quantity = #{quantity},
            </if>
            <if test="price != null">
                price = #{price},
            </if>
            <if test="typeId != null">
                type_id = #{typeId}
            </if>
        </set>
        WHERE id = #{id}
    </update>

    <!-- 根据仓库id和材料名称改变材料的数量 -->
    <update id="changeMaterial" parameterType="map">
        UPDATE material
        <set>

            <if test='state == "已入库"'>
                <if test="price != null">
                    quantity = quantity+#{quantity},
                </if>
                <if test="price != null">
                    price = price + #{price}
                </if>
            </if>
            <if test='state == "已出库"'>
                <if test="price != null">
                    quantity = quantity - #{quantity},
                </if>
                <if test="price != null">
                    price = price - #{price}
                </if>
            </if>

        </set>
        WHERE
        depository_id = #{depositoryId} and mname = #{mname},
    </update>

    <!-- 批量修改数据 -->
    <update id="updateMaterials" parameterType="list">
        <foreach collection="list" index="index" item="item" separator=";">
            UPDATE material
            <set>
                <if test="item.depositoryId != null">
                    depository_id = #{item.depositoryId},
                </if>
                <if test="item.mname != null">
                    mname = #{item.mname},
                </if>
                <if test="item.quantity != null">
                    quantity = #{item.quantity},
                </if>
                <if test="item.price != null">
                    price = #{item.price},
                </if>
                <if test="item.typeId != null">
                    type_id = #{item.typeId}
                </if>
            </set>
            WHERE id = #{item.id}
        </foreach>
    </update>
    
    <!-- 根据主键删除数据 -->
    <delete id="deleteMaterialById" parameterType="int">
        DELETE FROM material WHERE id = #{id}
    </delete>
    
    <!-- 根据主键批量删除数据 -->
    <delete id="deleteMaterialByIds" parameterType="list">
        DELETE FROM material WHERE id IN
        <foreach collection="list" index="index" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>
</mapper>